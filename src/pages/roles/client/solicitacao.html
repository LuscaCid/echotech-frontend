<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="stylesheet" href="./styles/paginasolicitacao.css">
    <link rel="stylesheet" href="../../../../../styles/constants.css">
    <link rel="stylesheet" href="../../../../styles/constants.css">
    <link rel="stylesheet" href="../../../../dist/output.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../../../js/solicitacao/index.js" defer type="module"></script>
    <title>Cliente - Solicitações</title>
    
</head>
<body class="bg-zinc-900">
    <header class="items-center pt-10 pb-20 py-2 w-full px-9 bg-zinc-800 flex justify-between border-b border-zinc-600">
        <div class="flex gap-10 items-center">
          <h1 class="text-4xl font-bold text-white">EcoTech</h1>
          <span class="text-2xl font-bold text-zinc-100 rounded-md bg-zinc-700 px-4 py-3">Ola, <span id="saudacao">Lucas</span></span>  
        </div>
        <div class="flex gap-2 ">
          
          <a href="./bonus.html" class="rounded-md p-4 text-2xl font-bold text-white border border-zinc-700  hover:bg-green-700 bg-green-600  duration-100">
            Loja 
          </a>
          <a href="./solicitacao.html" class="rounded-md p-4 text-2xl font-bold text-white border border-zinc-700 hover:bg-green-700 bg-green-600  duration-100">
            Gerar solicitação
          </a>
          <button class="rounded-md p-4 text-2xl font-bold text-white border border-zinc-700 hover:bg-green-600  duration-100">
            Logout
          </button>
        </div>
      </header>
    <main class="my-12 min-w-[600px] w-[1200px] m-auto  border border-zinc-600 text-zinc-100 text-2xl rounded-md bg-zinc-700">
        <h2>Solicitação de Entrega de Resíduos</h2>
    
        <form id="formulario" class="">
            <div class="">
                <div class="">
                    <label for="tipo_residuo">Resíduo:</label>
                    <select id="tipo_residuo" name="tipo_residuo">

                        <option >Selecione</option>

                    </select>
                </div>
                <div class="">
                    <label for="material">Material:</label>
                    <select id="material" name="material">

                    </select>
                </div>
                <div class="">
                    <label for="endereco_cliente">Endereço:</label>
                    <select id="endereco_cliente" name="endereco_cliente">
                        <option >Selecione</option>
                    </select>
                </div>
                <div class="">
                    <label for="numero">Quantidade:</label>
                    <input type="text" id="numero" name="numero" required>
                </div>
            </div>
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                   
            
                    // Função para carregar os endereços do cliente com base nos critérios selecionados
                    async function  carregarEnderecosCliente() {

                        const dados = JSON.parse(localStorage.getItem('@ecotech-dados'));                            
                        const {chave} = dados

                        const resposta = await fetch(
                            "http://192.168.0.135:8000/api/usuario/enderecos", 
                            {
                                method : "GET",
                                headers : {
                                    Authorization : 'Bearer ' + chave,
                            },
                        })
                        const respostaFormatada = await resposta.json()
                        console.log(respostaFormatada)
                        
                        const { enderecos } = respostaFormatada;
            
                        // Adicionar as opções dos endereços dos clientes ao select
                        enderecos.forEach(endereco => {
                            const option = document.createElement('option');
                            option.value = endereco.id_endereco;

                            option.textContent = endereco.nm_complemento;

                            enderecoClienteSelect.appendChild(option);
                        });
                    }
                    carregarEnderecosCliente();
                });
            </script>          
            <button type="submit">Enviar Solicitação</button>
        </form>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded",async function() {
            
            const tipoResiduoSelect = document.getElementById('tipo_residuo');
            const materialSelect = document.getElementById('material');
            const quantidadeInput = document.getElementById('numero');
            const enderecoClienteSelect = document.getElementById('endereco_cliente');
            const formulario = document.getElementById("formulario")
            // Função para carregar os endereços do cliente com base nos critérios selecionados



            const resposta = await fetch("http://192.168.0.135:8000/api/residuos/lista")
            const respostaFormatada = await resposta.json()

            function renderizarListaSelect (){
                for(const element of respostaFormatada) {
                    
                    const elementoOption = document.createElement("option")
                    
                    elementoOption.value = element.id_residuo;
                    elementoOption.innerText = element.nm_residuo;

                    tipoResiduoSelect.appendChild(elementoOption)
                }
            }
 
            renderizarListaSelect()

            
            function renderizarListaSelectMateriais (){
                
            }

            async function dispararEventoParaMudarValoresSelectMateriais() {
                
                const selectResiduosId = tipoResiduoSelect.value
                if(selectResiduosId != "Selecione") {
                    
                    console.log(selectResiduosId)
                    const respostaMateriais = await fetch(`http://192.168.0.135:8000/api/materiais/obter?id_residuo=${selectResiduosId}`)
                    
                    const respostaMateriaisFormatada = await respostaMateriais.json()

                    console.log(respostaMateriaisFormatada)

                    const options = materialSelect.querySelectorAll("option")

                    for(const option of options) {
                        console.log(option)
                        option.remove()
                    }

                    for(const element of respostaMateriaisFormatada) {
                        
                        const elementoOption = document.createElement("option")
                    
                        elementoOption.value = element.id_material;
                        elementoOption.innerText = element.nm_material;
                        elementoOption.className = "option"

                        materialSelect.appendChild(elementoOption)
                        console.log(tipoResiduoSelect)
                    }

                }
                
                
            }           
    
            tipoResiduoSelect.addEventListener("change", dispararEventoParaMudarValoresSelectMateriais)
            
            formulario.addEventListener("submit", async (e) => {
                e.preventDefault()
                const formData = new FormData()
                
                formData.append("id_endereco", enderecoClienteSelect.value)
                formData.append("id_material", materialSelect.value)
                formData.append("qt_material", quantidadeInput.value)
                
                const localstorage = localStorage.getItem("@ecotech-dados")
                const tokenParsed = JSON.parse(localstorage)
                const { chave } = tokenParsed
                try{
                    const resposta = await fetch ("http://192.168.0.135:8000/api/solicitacoes/adicionar", {
                        method : "POST",
                        body : formData,
                        headers : {
                            
                            Authorization : "Bearer " + chave
                        }
                    })
                    const respostaFormatada = await resposta.json()
                    
                    if(respostaFormatada.inserido) {
                        return window(respostaFormatada.inserido)
                        
                    } else if (respostaFormatada.falha) {
                        return window(respostaFormatada.falha)
                        
                    }
                } catch (exception ) {
                    alert(exception)
                }

            })
            // Chamar a função inicialmente para preencher os endereços

        });
    </script>

</body>
</html>
